<html>
<head><title>Brussels Mobility</title></head>
<body>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<script>
  /*
   * an example that obtains and processes data
   * to make it fit for an exercise in dataviz
   *
   * the final result is an ever-growing array of data
   * that contains, for every snapshot,
   * the cumulated length of traffic conditions
   * (red, orange, green) and the number of different
   * locations involved
   *
   * CD 20140207
   */
  $(document).ready(
    function(){
      var resultList=[];
      var Timer;
      function accumulateLength(value, soFar){
	var runningTotal=soFar;
	$(value.geometry.coordinates.slice(1)).each(
	  function(i,coord){// the data are in "Lambert 72" form, that is : X,Y
	    runningTotal+=Math.sqrt(Math.pow((coord[0]-value.geometry.coordinates[i][0]),2)+Math.pow((coord[1]-value.geometry.coordinates[i][1]),2));
	  });
	return runningTotal;
      }
      function collectData(){
	var Result={"RED":0,"GREEN":0,"ORANGE":0,"cntGREEN":0,"cntORANGE":0,"cntRED":0};
	$.getJSON("http://christian-delfosse.infographie-heaj.eu/Test/jsonTOjsonp.php?jsoncallback=?",// convert JSON to JSONP
		  {url:"http://data.irisnetlab.be/data/levels_of_service/json/"},                     // the data provider
		  function(data){
		    var RED=0,ORANGE=0,GREEN=0;
                    $(data.features).each(
		      function(index,value){
			if (!(value.geometry.type=="LineString"))
			  console.log(index+value);// report unknown case
			else {
			  switch(value.properties.level_of_service){
			  case "ORANGE":
			    ORANGE=accumulateLength(value,ORANGE);
			    Result.cntORANGE+=1;
			    break;
			  case "ROUGE":
			    RED=accumulateLength(value,RED);
			    Result.cntRED+=1;
			    break;
			  case "VERT":
			    GREEN=accumulateLength(value,GREEN);
			    Result.cntGREEN+=1;
			    break;
			  }
			}});
		    //console.log(RED.toFixed(0));
		    Result.GREEN=GREEN;
		    Result.ORANGE=ORANGE;
		    Result.RED=RED;
		  });
	resultList.push(Result);
	console.log(resultList);
      }
      collectData();// setInterval does not start immediately
      Timer=setInterval(collectData,2.1*60*1000);
    });
</script>
</body></html>
